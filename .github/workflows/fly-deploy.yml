name: CI/CD Task-API (Fly.io)

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    environment: production
    env:
      FLY_APP: task-api
      FLY_REGION: iad
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

    defaults:
      run:
        working-directory: task-api

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Go 1.24.2
        uses: actions/setup-go@v4
        with:
          go-version: '1.24.2'

      - name: Run unit tests
        run: go test ./internal/task -v

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@v1
        with:
          version: 'latest'  # ó fija la versión que prefieras

      - name: Ensure Fly app exists
        run: |
          if ! flyctl apps list | grep -qx "${FLY_APP}"; then
            flyctl apps create "${FLY_APP}"
          fi


      - name: Deploy to Fly.io
        run: |
          flyctl deploy \
            --app $FLY_APP \
            --region $FLY_REGION \
            --remote-only
